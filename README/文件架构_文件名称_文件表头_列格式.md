# K线下载阶段文件架构与格式规范

## 一、概述
本文聚焦 **K线下载阶段** 的文件架构与格式，只覆盖 `raw_download`、`incremental`、`merged`、`.download_state` 四个目录，区分 Binance / OKX / Bybit 以及 Spot / Swap（Bybit 的 Swap 对应 linear）。  
- 数据根目录：`D:\history data\klinedata`  
- 代码目录：`D:\code\1.klinedownload\`，入口：`launcher_refactored.py`  
- 目标：统一路径、命名、表头、类型，规避 symbol / interval 格式混用。

## 二、时间周期与 Symbol 格式规范
- **时间周期映射表**
| 简写 | 完整格式 | 适用目录 |
|------|----------|----------|
| 1m | 1min | .download_state |
| 5m | 5min | .download_state |
| 15m | 15min | .download_state |
| 1h | 1hour | .download_state |
| 4h | 4hour | .download_state |
| 1d | 1day | .download_state |
| 1w | 1week | .download_state |
| 1M | 1month | .download_state |
| （以上简写 ↔ 完整格式） | （raw_download / incremental / merged 全部使用完整格式） |  |

- **Symbol 格式**
| 目录 | Symbol格式 | 示例 | 说明 |
|------|------------|------|------|
| raw_download | 下划线 | ETH_USDT | ⚠️ 文件名与目录名都用下划线 |
| incremental | 下划线 | ETH_USDT | 与 raw_download 一致 |
| merged | 下划线 | ETH_USDT | 与 raw_download 一致 |
| .download_state | 无下划线 | ETHUSDT | ⚠️ tracker 特殊：目录名与文件内容均无下划线 |

## 三、原始下载数据（raw_download）
### 3.1 Binance 交易所
#### 3.1.1 Spot 市场
- 存储路径：`D:\history data\klinedata\raw_download\binance\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}.csv`，symbol 下划线，interval 用完整格式。
- 完整列名与数据类型（12 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 开盘时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量（基础币） |
| close_time | int64 | 收盘时间戳（毫秒） |
| quote_volume | float64 | 成交额（计价币） |
| count | int64 | 成交笔数 |
| taker_buy_volume | float64 | 主动买量（基础币） |
| taker_buy_quote_volume | float64 | 主动买额（计价币） |
- 示例：`D:\history data\klinedata\raw_download\binance\spot\ETH_USDT\ETH_USDT_1min_binance.csv`

#### 3.1.2 Swap 市场
- 存储路径：`D:\history data\klinedata\raw_download\binance\swap\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_Swap.csv`，symbol 下划线，interval 完整格式。
- 完整列名与数据类型（12 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 开盘时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| close_time | int64 | 收盘时间戳（毫秒） |
| quote_volume | float64 | 成交额 |
| trades | int64 | 交易笔数 |
| taker_buy_base | float64 | 主动买量（基础币） |
| taker_buy_quote | float64 | 主动买额（计价币） |
- ⚠️ 差异：Spot 用 `count/taker_buy_volume/taker_buy_quote_volume`，Swap 用 `trades/taker_buy_base/taker_buy_quote`。
- 示例：`D:\history data\klinedata\raw_download\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_Swap.csv`

### 3.2 OKX 交易所
#### 3.2.1 Spot 市场
- 存储路径：`D:\history data\klinedata\raw_download\okx\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}.csv`
- 完整列名与数据类型（Spot/Swap 通用，10 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| volume_currency | float64 | 成交额（币本位） |
| volume_quote | float64 | 成交额（计价币） |
| confirm | int64 | 成交确认标记 |
- 示例：`D:\history data\klinedata\raw_download\okx\spot\ETH_USDT\ETH_USDT_1hour_okx.csv`

#### 3.2.2 Swap 市场
- 存储路径：`D:\history data\klinedata\raw_download\okx\swap\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_Swap.csv`
- 列与 Spot 完全一致（同上表）。  
- 示例：`D:\history data\klinedata\raw_download\okx\swap\ETH_USDT\ETH_USDT_1day_okx_Swap.csv`

### 3.3 Bybit 交易所
#### 3.3.1 Spot 市场
- 存储路径：`D:\history data\klinedata\raw_download\bybit\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}.csv`
- 完整列名与数据类型（Spot/Swap 通用，7 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
- 示例：`D:\history data\klinedata\raw_download\bybit\spot\ETH_USDT\ETH_USDT_1min_bybit.csv`

#### 3.3.2 Swap 市场（linear）
- 存储路径：`D:\history data\klinedata\raw_download\bybit\swap\{symbol}\`（目录名用 swap）
- 文件命名：`{symbol}_{interval}_{exchange}_Swap.csv`
- 列与 Spot 完全一致（同上表）。  
- ⚠️ Bybit 代码层 market_type 可能为 `linear`，落盘目录/文件统一用 `swap` + `_Swap` 后缀。
- 示例：`D:\history data\klinedata\raw_download\bybit\swap\ETH_USDT\ETH_USDT_1day_bybit_Swap.csv`

## 四、增量数据（incremental）
### 4.1 Binance 交易所
#### 4.1.1 Spot 市场
- 存储路径：`D:\history data\klinedata\incremental\binance\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_{date}.csv`，`date`=YYYY-MM-DD。
- 完整列名与数据类型（与 raw_download Spot 相同，12 列）  
| 列名 | 类型 | 列名 | 类型 |
|------|------|------|------|
| timestamp | int64 | volume | float64 |
| datetime | object | close_time | int64 |
| open | float64 | quote_volume | float64 |
| high | float64 | count | int64 |
| low | float64 | taker_buy_volume | float64 |
| close | float64 | taker_buy_quote_volume | float64 |
- 示例：`D:\history data\klinedata\incremental\binance\spot\ETH_USDT\ETH_USDT_1day_binance_2025-10-31.csv`

#### 4.1.2 Swap 市场
- 存储路径：`D:\history data\klinedata\incremental\binance\swap\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_Swap_{date}.csv`
- 完整列名与数据类型（与 raw_download Swap 相同，12 列）  
| 列名 | 类型 | 列名 | 类型 |
|------|------|------|------|
| timestamp | int64 | volume | float64 |
| datetime | object | close_time | int64 |
| open | float64 | quote_volume | float64 |
| high | float64 | trades | int64 |
| low | float64 | taker_buy_base | float64 |
| close | float64 | taker_buy_quote | float64 |
- 示例：`D:\history data\klinedata\incremental\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_Swap_2025-10-31.csv`

### 4.2 OKX 交易所
#### 4.2.1 Spot 市场
- 存储路径：`D:\history data\klinedata\incremental\okx\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_{date}.csv`
- 完整列名与数据类型（Spot/Swap 通用，10 列）  
| 列名 | 类型 | 列名 | 类型 |
|------|------|------|------|
| timestamp | int64 | volume | float64 |
| datetime | object | volume_currency | float64 |
| open | float64 | volume_quote | float64 |
| high | float64 | confirm | int64 |
| low | float64 | close | float64 |
- 示例：`D:\history data\klinedata\incremental\okx\spot\ETH_USDT\ETH_USDT_1hour_okx_2025-10-31.csv`

#### 4.2.2 Swap 市场
- 存储路径：`D:\history data\klinedata\incremental\okx\swap\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_Swap_{date}.csv`
- 列与 Spot 完全一致（同上表）。  
- 示例：`D:\history data\klinedata\incremental\okx\swap\ETH_USDT\ETH_USDT_1day_okx_Swap_2025-10-31.csv`

### 4.3 Bybit 交易所
#### 4.3.1 Spot 市场
- 存储路径：`D:\history data\klinedata\incremental\bybit\spot\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_{date}.csv`
- 完整列名与数据类型（Spot/Swap 通用，7 列）  
| 列名 | 类型 | 说明 |
|------|------|------|
| timestamp | int64 | 时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
- 示例：`D:\history data\klinedata\incremental\bybit\spot\ETH_USDT\ETH_USDT_1min_bybit_2025-10-31.csv`

#### 4.3.2 Swap 市场（linear）
- 存储路径：`D:\history data\klinedata\incremental\bybit\swap\{symbol}\`
- 文件命名：`{symbol}_{interval}_{exchange}_Swap_{date}.csv`
- 列与 Spot 完全一致（同上表）。  
- 示例：`D:\history data\klinedata\incremental\bybit\swap\ETH_USDT\ETH_USDT_1hour_bybit_Swap_2025-10-31.csv`

## 五、合并数据（merged）
> merged 文件仍保持原始列结构；interval 用完整格式；symbol 下划线。

### 命名格式区别（⚠️ 同目录可能共存）
- **FileManager 格式**（shared/file_manager.py）：`{symbol}_{interval}_{exchange}_{MarketType}_merged_vYYYYMMDD.csv` / `_merged_latest.csv`（MarketType=Spot/Swap，首字母大写）。
- **MergeConfig 格式**（merge/merge_config.py）：`{symbol}_{interval}_{exchange}[_Swap]_merged_vYYYYMMDD.csv` / `_merged_latest.csv`（Swap 加 `_Swap`，Spot 无后缀）。

### 5.1 Binance 交易所
#### 5.1.1 Spot 市场
- 存储路径：`D:\history data\klinedata\merged\binance\spot\{symbol}\`
- 文件命名：支持 FileManager 与 MergeConfig 两种格式（见上）。Latest 去掉日期改为 `latest`。
- 完整列名与数据类型（12 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 开盘时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量（基础币） |
| close_time | int64 | 收盘时间戳（毫秒） |
| quote_volume | float64 | 成交额（计价币） |
| count | int64 | 成交笔数 |
| taker_buy_volume | float64 | 主动买量（基础币） |
| taker_buy_quote_volume | float64 | 主动买额（计价币） |
- 示例  
  - FileManager：`D:\history data\klinedata\merged\binance\spot\ETH_USDT\ETH_USDT_1hour_binance_Spot_merged_v20251031.csv`  
  - MergeConfig：`D:\history data\klinedata\merged\binance\spot\ETH_USDT\ETH_USDT_1hour_binance_merged_v20251031.csv`

#### 5.1.2 Swap 市场
- 存储路径：`D:\history data\klinedata\merged\binance\swap\{symbol}\`
- 文件命名：两种格式，Swap 需带 `_Swap` 后缀（MergeConfig）或 MarketType=Swap（FileManager）。
- 完整列名与数据类型（12 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 开盘时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| close_time | int64 | 收盘时间戳（毫秒） |
| quote_volume | float64 | 成交额 |
| trades | int64 | 交易笔数 |
| taker_buy_base | float64 | 主动买量（基础币） |
| taker_buy_quote | float64 | 主动买额（计价币） |
- 示例  
  - FileManager：`D:\history data\klinedata\merged\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_Swap_merged_latest.csv`  
  - MergeConfig：`D:\history data\klinedata\merged\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_Swap_merged_v20251031.csv`

### 5.2 OKX 交易所
#### 5.2.1 Spot 市场
- 存储路径：`D:\history data\klinedata\merged\okx\spot\{symbol}\`
- 文件命名：支持两种格式（同上）。
- 完整列名与数据类型（Spot/Swap 通用，10 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| volume_currency | float64 | 成交额（币本位） |
| volume_quote | float64 | 成交额（计价币） |
| confirm | int64 | 成交确认标记 |
- 示例：`D:\history data\klinedata\merged\okx\spot\ETH_USDT\ETH_USDT_1day_okx_Spot_merged_latest.csv`

#### 5.2.2 Swap 市场
- 存储路径：`D:\history data\klinedata\merged\okx\swap\{symbol}\`
- 文件命名：两种格式；Swap 带 `_Swap`（MergeConfig）或 MarketType=Swap（FileManager）。
- 列与 Spot 完全一致。
- 示例：`D:\history data\klinedata\merged\okx\swap\ETH_USDT\ETH_USDT_1day_okx_Swap_merged_v20251031.csv`

### 5.3 Bybit 交易所
#### 5.3.1 Spot 市场
- 存储路径：`D:\history data\klinedata\merged\bybit\spot\{symbol}\`
- 文件命名：两种格式同样适用；Spot 无 `_Swap`。
- 完整列名与数据类型（Spot/Swap 通用，7 列）  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 时间戳（毫秒） |
| datetime | object | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
- 示例：`D:\history data\klinedata\merged\bybit\spot\ETH_USDT\ETH_USDT_1min_bybit_Spot_merged_latest.csv`

#### 5.3.2 Swap 市场（linear）
- 存储路径：`D:\history data\klinedata\merged\bybit\swap\{symbol}\`
- 文件命名：两种格式；MergeConfig 带 `_Swap`，FileManager MarketType=Swap。
- 列与 Spot 完全一致。
- 示例：`D:\history data\klinedata\merged\bybit\swap\ETH_USDT\ETH_USDT_1min_bybit_Swap_merged_v20251031.csv`

## 六、下载状态追踪（.download_state）
- 存储路径：`.download_state/{exchange}/{market_type}/{symbol}/`
- 文件命名：`{interval}.json`
- ⚠️ 关键特殊性：symbol 无下划线（如 `ETHUSDT`），interval 必用简写（1m/1h/1d 等）。
- 示例  
  - Binance Spot：`D:\history data\klinedata\.download_state\binance\spot\ETHUSDT\1m.json`  
  - OKX Swap：`D:\history data\klinedata\.download_state\okx\swap\ETHUSDT\1h.json`  
  - Bybit Swap：`D:\history data\klinedata\.download_state\bybit\swap\ETHUSDT\4h.json`
- JSON 内容字段随实现可扩展，常见包含 `exchange`、`market_type`、`symbol`、`interval`、`last_download_time` 等，用于增量续传。

## 七、关键差异总结
| 交易所 | 市场 | 列数 | 特殊列 | 命名后缀 | 目录 symbol | interval 规则 |
|--------|------|------|--------|----------|-------------|--------------|
| Binance | Spot | 12 | count / taker_buy_volume / taker_buy_quote_volume | raw/incremental 无 `_Swap`；merged 依模式带 MarketType | 下划线 | raw/incremental/merged 用完整格式 |
| Binance | Swap | 12 | trades / taker_buy_base / taker_buy_quote | 文件名带 `_Swap` | 下划线 | 同上 |
| OKX | Spot | 10 | volume_currency / volume_quote / confirm | Spot 无 `_Swap` | 下划线 | 同上 |
| OKX | Swap | 10 | 同 Spot | 带 `_Swap` | 下划线 | 同上 |
| Bybit | Spot | 7 | 无额外列 | Spot 无 `_Swap` | 下划线 | 同上 |
| Bybit | Swap(linear) | 7 | 与 Spot 相同 | 带 `_Swap`；目录仍用 swap | 下划线 | 同上 |
| .download_state | Spot/Swap | JSON | last_download_time 等 | 文件名直接 interval.json | 无下划线 | ⚠️ 只用简写 |

## 八、注意事项
- ⚠️ merged 目录需同时兼容 FileManager 与 MergeConfig 两种命名，读取时优先 latest，其次按版本号匹配。
- ⚠️ tracker（`.download_state`）symbol 必无下划线，interval 必简写；不要混用完整格式。
- 🔍 Bybit 代码中的 `linear` 统一映射到目录/文件的 `swap` 与 `_Swap` 后缀，避免生成 `linear` 目录。
- 🔍 Binance Spot 与 Swap 列名不同，清洗或合并时勿混表头；OKX、Bybit Spot/Swap 列完全一致。
- 路径构造时同时校验 symbol 和 interval 格式，尤其在跨目录处理（raw → incremental → merged → tracker）时保持一致。



阶段二：
# K线打标阶段文件架构与格式规范（代码核验）

## 1. 范围与根目录
- 范围：仅涵盖第一步“K线打标/预标记”输出（marked_data / error_reports / statistics / logs / metadata），不涉及下载、增量、合并。
- 输入根目录（Config.RAW_DATA_ROOT，WORK_MODE≠testcase）：`D:\history data\klinedata\raw_download`
- 输出根目录（Config.CLEANED_ROOT）：`D:\history data\klinedata\1.cleaned_step1_pre_mark`
- 测试用例模式：WORK_MODE="testcase" 时切换到 `D:\code\2.dataclean\1.cleaned_step1_pre_mark\testsystem` 与 `...\testresualt`，目录层级保持一致。

## 2. 时间周期与 Symbol 规则
- 时间周期映射（打标文件 period 使用完整格式；tracker 使用简写）  
| 简写 | 完整格式 | 说明 |
|------|----------|------|
| 1m | 1min | 1分钟 |
| 5m | 5min | 5分钟 |
| 15m | 15min | 15分钟 |
| 1h | 1hour | 1小时 |
| 4h | 4hour | 4小时 |
| 1d | 1day | 1天 |
| 1w | 1week | 1周 |
| 1M | 1month | 1个月 |
- period 取自 FileNameParser.parse_filename 的完整格式；TimeSeriesValidator 只对上述周期做连续性校验。
- Symbol：打标相关目录统一使用下划线+大写（如 `ETH_USDT`）。⚠️ tracker（`.download_state`）依旧使用无下划线格式（`ETHUSDT`），且文件名用周期简写。

## 3. 打标阶段目录与命名
### 3.1 marked_data（含全量行）
- 路径：`{CLEANED_ROOT}/marked_data/{exchange}/{market_type}/{symbol}/`
- 文件名：`{symbol}_{period}_{exchange}_{market_type}_premark.csv`（market_type=spot|swap）
- 示例：`D:\history data\klinedata\1.cleaned_step1_pre_mark\marked_data\binance\spot\ETH_USDT\ETH_USDT_1min_binance_spot_premark.csv`
- 内容：原始K线列（保留 `timestamp_original` 副本）+ 9 个错误列；不包含 `raw_status`/`error_list`。

### 3.2 error_reports（仅错误行）
- 路径：`{CLEANED_ROOT}/error_reports/{exchange}/{market_type}/{symbol}/`
- 文件名：`{symbol}_{period}_{exchange}_errors.csv`（⚠️ 文件名不带 market_type 后缀）
- 示例：`D:\history data\klinedata\1.cleaned_step1_pre_mark\error_reports\okx\swap\ETH_USDT\ETH_USDT_1hour_okx_errors.csv`
- 内容：标记文件中 `raw_status`≠`V` 的行；列 = marked_data 列 + `raw_status`（V/E/D）+ `error_list`（分号分隔去重后的错误码）。

### 3.3 statistics
- by_symbol_period（DataSaver）：`statistics/by_symbol_period/{exchange}/{market_type}/{symbol}/{symbol}_{period}_{exchange}_stats.{csv|json}`  
  示例：`D:\history data\klinedata\1.cleaned_step1_pre_mark\statistics\by_symbol_period\bybit\spot\ETH_USDT\ETH_USDT_1day_bybit_stats.csv`
- by_exchange（StatisticsGenerator）：`statistics/by_exchange/{exchange}_summary.{csv|json}`
- by_symbol（StatisticsGenerator）：`statistics/by_symbol/{symbol}_all_periods.{csv|json}`
- global（StatisticsGenerator）：`statistics/global/processing_summary.json`；`statistics/global/error_distribution.{csv|json}`

### 3.4 logs
- 处理日志：`logs/processing_logs/by_symbol_period/{exchange}/{market_type}/{symbol}/{symbol}_{period}_{exchange}_processing.log`
- 汇总日志：`logs/processing_logs/by_exchange/{exchange}_processing.log`；`logs/processing_logs/by_symbol/{symbol}_processing.log`；`logs/processing_logs/global/{main|error_summary|performance_metrics}_processing.log`
- 系统日志：`logs/system_logs/{info|debug|error}/{level_YYYYMMDD}.log`

### 3.5 metadata 与失败清单
- metadata：`metadata/processing_config.json`、`metadata/file_manifest.json`、`metadata/error_details.json`、`metadata/processing_summary.json`
- 失败清单：`error_reports/失败列表.csv`（批处理失败汇总），`logs/failed_files_list.txt`（断点续传记录）

### 3.6 tracker 特殊性
- tracker（`.download_state`）不在打标输出内，但会被工具读取：symbol 无下划线、interval 简写，避免与 marked_data 路径混用。

## 4. 标记文件表头与列格式（按交易所/市场）
- 通用错误列：`timestamperro`, `openerro`, `higherro`, `lowerro`, `closeerro`, `volumeerro`, `OHLC Logic`, `Time Series`, `Price Precision`（字符串）。
- 所有市场均携带 `timestamp_original`（非 testcase 模式由 DataLoader 复制原始时间戳）。

### 4.1 Binance
#### 4.1.1 Spot
- 路径示例：`...\marked_data\binance\spot\ETH_USDT\ETH_USDT_1min_binance_spot_premark.csv`
- 列与类型  
| 列名 | 数据类型 | 说明 |
|------|----------|------|
| timestamp | int64 | 开盘时间戳（毫秒） |
| timestamp_original | int64 | 原始时间戳副本 |
| datetime | Utf8 | 可读时间 |
| open | float64 |  |
| high | float64 |  |
| low | float64 |  |
| close | float64 |  |
| volume | float64 | 成交量 |
| close_time | int64 | 收盘时间戳（毫秒） |
| quote_volume | float64 | 成交额 |
| count | int64 | 成交笔数 |
| taker_buy_volume | float64 | 主动买量 |
| taker_buy_quote_volume | float64 | 主动买额 |
| 9个错误列 | Utf8 | 见第5节 |
- ⚠️ Spot 专属：`count` / `taker_buy_volume` / `taker_buy_quote_volume`。
- 错误报告示例：`...\error_reports\binance\spot\ETH_USDT\ETH_USDT_1min_binance_errors.csv`

#### 4.1.2 Swap
- 路径示例：`...\marked_data\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_swap_premark.csv`
- 列与类型：`timestamp, timestamp_original, datetime, open, high, low, close, volume, close_time, quote_volume, trades(int64), taker_buy_base(float64), taker_buy_quote(float64)` + 9 个错误列。
- ⚠️ Swap 专属：`trades` / `taker_buy_base` / `taker_buy_quote`；不含 Spot 的 `count` / `taker_buy_volume` / `taker_buy_quote_volume`。
- 错误报告示例：`...\error_reports\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_errors.csv`

### 4.2 OKX
- Spot 路径示例：`...\marked_data\okx\spot\ETH_USDT\ETH_USDT_4hour_okx_spot_premark.csv`
- 列与类型：`timestamp, timestamp_original, datetime, open, high, low, close, volume, volume_currency(float64), volume_quote(float64), confirm(int64)` + 9 个错误列。
- Swap 路径示例：`...\marked_data\okx\swap\ETH_USDT\ETH_USDT_1day_okx_swap_premark.csv`（列完全一致）。
- 错误报告示例：`...\error_reports\okx\swap\ETH_USDT\ETH_USDT_1day_okx_errors.csv`

### 4.3 Bybit
- Spot 路径示例：`...\marked_data\bybit\spot\ETH_USDT\ETH_USDT_1min_bybit_spot_premark.csv`
- 列与类型：`timestamp, timestamp_original, datetime, open, high, low, close, volume` + 9 个错误列。
- Swap（linear）路径示例：`...\marked_data\bybit\swap\ETH_USDT\ETH_USDT_1day_bybit_swap_premark.csv`（目录名为 swap，列与 Spot 相同）。
- 错误报告示例：`...\error_reports\bybit\swap\ETH_USDT\ETH_USDT_1day_bybit_errors.csv`

## 5. 错误类型与列映射（DataSaver.ErrorClassifier）
- 状态码：`raw_status` 取值 `V`(valid)/`E`(error)/`D`(delete，NA填充)，写入 error_reports 与 statistics。
- 列到错误码映射（均以分号分隔、去重、排序）  
| 错误列 | 可能的错误码 |
|--------|--------------|
| timestamperro | MISSING_TIMESTAMP, UNCONVERTIBLE_TIMESTAMP, INVALID_TIMESTAMP, INVALID_TIMESTAMP_FORMAT, TIMESTAMP_RANGE_ERROR, FUTURE_TIMESTAMP, DUPLICATE_TIMESTAMP, DUPLICATE_TIMESTAMP_SAME, TIME_DISORDER |
| openerro / higherro / lowerro / closeerro | MISSING_OHLCV, INVALID_OHLCV_DTYPE, UNCONVERTIBLE_OPEN/HIGH/LOW/CLOSE, NULL_VALUE, NEGATIVE_PRICE |
| volumeerro | MISSING_OHLCV, INVALID_OHLCV_DTYPE, UNCONVERTIBLE_VOLUME, NULL_VALUE, ZERO_VOLUME, NEGATIVE_VOLUME |
| OHLC Logic | HL_SWAP, H_OUT_BOTH, L_OUT_BOTH, H_OUT_OCMAX, L_OUT_OCMIN |
| Time Series | MISSING_TIMEPERIOD |
| Price Precision | PRICE_PRECISION_LOSS |
- 全量错误码（Config）：  
`H_OUT_OCMAX, H_OUT_BOTH, L_OUT_OCMIN, L_OUT_BOTH, HL_SWAP, NEGATIVE_PRICE, NULL_VALUE, NEGATIVE_VOLUME, MISSING_TIMESTAMP, UNCONVERTIBLE_TIMESTAMP, INVALID_TIMESTAMP, FUTURE_TIMESTAMP, DUPLICATE_TIMESTAMP, DUPLICATE_TIMESTAMP_SAME, TIME_DISORDER, MISSING_OHLCV, ZERO_VOLUME, INVALID_OHLCV_DTYPE, UNCONVERTIBLE_OPEN, UNCONVERTIBLE_HIGH, UNCONVERTIBLE_LOW, UNCONVERTIBLE_CLOSE, UNCONVERTIBLE_VOLUME, INVALID_TIMESTAMP_FORMAT, TIMESTAMP_RANGE_ERROR, MISSING_TIMEPERIOD, PRICE_PRECISION_LOSS`

## 6. 关键差异与注意事项
- ⚠️ error_reports 文件名不含 market_type，依赖目录层级区分市场类型。
- 🔍 非 testcase 模式会输出 `timestamp_original`，便于追溯原始时间戳单位。
- 🔍 Bybit 永续仍以 `swap` 目录 + `_swap_premark` 文件名落盘，代码侧不存在 `linear` 目录。
- 🔍 统计文件分四层（by_symbol_period/by_exchange/by_symbol/global），命名为 `{symbol}_{period}_{exchange}_stats.*`，不同于旧文档的 `_statistics` 后缀。
- ⚠️ tracker 使用无下划线 + 周期简写，避免误放入 marked_data/error_reports/statistics。
- 测试模式（WORK_MODE="test"）默认仅取每个交易所首个 symbol；AUTO_CLEAN_TEST_FOLDERS 会清理示例输出目录，勿在该目录存放生产文件。



# K线异常值 NaN 填充阶段文件架构与格式（_firstclean）

## 7. 阶段范围与目录总览
- 本节对应代码仓库 `D:\code\2.dataclean\2.cleaned_step2_second_mark`，入口 `main.py` / `kline_data_cleaner.py`，核心逻辑 `DataProcessor.clean_data`（基于打标结果的 NaN 填充，保留行位次）。
- 输入根目录：`D:\history data\klinedata\1.cleaned_step1_pre_mark\marked_data\{exchange}\{market_type}\{symbol}\*_premark.csv`
- 输出根目录：`D:\history data\klinedata\2.cleaned_step2_firstdataclean\{exchange}\{market_type}\{symbol}\*_firstclean.csv`（`_premark` 后缀替换为 `_firstclean`，其余保持一致）。
- 辅助输出：`logs/`（系统日志）、`reports/`（JSON 报告）、`temp/`（兜底输出）、`Processing_time.csv`（记录 exchange/market/filename/timeframe/duration）。
- 处理策略核心：仅对**已有错误标记的行**做 NaN 填充（保持行数），严重错误批量填充，OHLCV 错误计数阈值>2 时整行 OHLCV 置空，时间序列缺口插入新行并标记 `MISSING_TIMEPERIOD`。

## 8. 时间周期与 Symbol 规范（清洗阶段）
- 时间周期映射（`_parse_interval_from_filename` 支持简写/全称，输出文件仍沿用输入命名约定）  
| 简写 | 完整格式 | 间隔(分钟) | 说明 |
|------|----------|-----------|------|
| 1m / 1min | 1min | 1 | 发现文件与插值均支持 |
| 3m / 3min | 3min | 3 |  |
| 5m / 5min | 5min | 5 |  |
| 15m / 15min | 15min | 15 |  |
| 30m / 30min | 30min | 30 |  |
| 1h / 1hour | 1hour | 60 |  |
| 2h / 2hour | 2hour | 120 |  |
| 4h / 4hour | 4hour | 240 |  |
| 6h / 6hour | 6hour | 360 |  |
| 8h / 8hour | 8hour | 480 |  |
| 12h / 12hour | 12hour | 720 |  |
| 1d / 1day | 1day | 1440 |  |
| 3d / 3day | 3day | 4320 |  |
| 1w / 1week | 1week | 10080 |  |
| 1M / 1mon / 1month | 1month | 43200 | 映射为 1 月周期 |
- Symbol：`marked_data`/`firstclean` 目录统一使用下划线格式（如 `ETH_USDT`）；⚠️ tracker/`.download_state` 仍使用无下划线 + 周期简写（如 `ETHUSDT/1m.json`），避免混放。

## 9. 目录与文件命名规则（_premark → _firstclean）
- 发现规则：只处理 `*_premark.csv`，保持 `{exchange}/{market_type}/{symbol}/` 三级目录不变。
- 输出命名：`{symbol}_{interval}_{exchange}_{market}_firstclean.csv`，其中 `{market}` 取 `spot` 或 `swap`（Bybit 永续目录名仍为 `swap`）。
- 路径示例（输入 → 输出）：
  - Binance Spot：`...\marked_data\binance\spot\ETH_USDT\ETH_USDT_1day_binance_spot_premark.csv` → `...\2.cleaned_step2_firstdataclean\binance\spot\ETH_USDT\ETH_USDT_1day_binance_spot_firstclean.csv`
  - Binance Swap：`...\marked_data\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_swap_premark.csv` → `...\2.cleaned_step2_firstdataclean\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_swap_firstclean.csv`
  - OKX Spot：`...\marked_data\okx\spot\BTC_USDT\BTC_USDT_4hour_okx_spot_premark.csv` → `...\2.cleaned_step2_firstdataclean\okx\spot\BTC_USDT\BTC_USDT_4hour_okx_spot_firstclean.csv`
  - OKX Swap：`...\marked_data\okx\swap\BTC_USDT\BTC_USDT_1day_okx_swap_premark.csv` → `...\2.cleaned_step2_firstdataclean\okx\swap\BTC_USDT\BTC_USDT_1day_okx_swap_firstclean.csv`
  - Bybit Spot：`...\marked_data\bybit\spot\ETH_USDT\ETH_USDT_15min_bybit_spot_premark.csv` → `...\2.cleaned_step2_firstdataclean\bybit\spot\ETH_USDT\ETH_USDT_15min_bybit_spot_firstclean.csv`
  - Bybit Swap（linear）：`...\marked_data\bybit\swap\ETH_USDT\ETH_USDT_1week_bybit_swap_premark.csv` → `...\2.cleaned_step2_firstdataclean\bybit\swap\ETH_USDT\ETH_USDT_1week_bybit_swap_firstclean.csv`
- 伴随文件：`Processing_time.csv` 追加 `exchange, market_type, filename, timeframe, duration_seconds`；`reports/processing_report_{mode}_{ts}.json` 汇总总行数/清洗行数/错误行数。

## 10. 交易所与市场类型的列名、数据类型（firstclean 输出）
> 核心列类型在 `_optimize_dtypes` 中强制：`timestamp` int64，`datetime` Utf8，OHLCV 为 float64；错误列 & `error_flag` 为 Utf8。若输入含 `timestamp_original` 将被保留。写出 CSV 时 `None` → 空字符串。

### 10.1 Binance
#### 10.1.1 Spot
- 路径示例：`...\2.cleaned_step2_firstdataclean\binance\spot\1A_USDT\1A_USDT_1day_binance_spot_firstclean.csv`
- 列与类型  
| 列名 | 类型 | 说明 |
|------|------|------|
| timestamp | int64 | 毫秒时间戳（核心填充列） |
| datetime | Utf8 | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量（基础币） |
| close_time | int64 | 收盘时间戳 |
| quote_volume | float64 | 成交额（计价币） |
| count | int64 | 成交笔数 |
| taker_buy_volume | float64 | 主动买量（基础币） |
| taker_buy_quote_volume | float64 | 主动买额（计价币） |
| timestamp_original | int64 | 原始时间戳（存在时保留） |
| timestamperro | Utf8 | 时间戳错误标记 |
| openerro | Utf8 | 开盘价错误标记 |
| higherro | Utf8 | 最高价错误标记 |
| lowerro | Utf8 | 最低价错误标记 |
| closeerro | Utf8 | 收盘价错误标记 |
| volumeerro / volumerro | Utf8 | 成交量错误标记（两种拼写择一存在） |
| OHLC Logic | Utf8 | OHLC 逻辑错误标记 |
| Time Series | Utf8 | 时间序列错误标记 |
| Price Precision | Utf8 | 价格精度错误标记 |
| error_flag | Utf8 | 本阶段填充时汇总的错误（用 `|` 连接） |
- ⚠️ 核心差异：Spot 与 Swap 在本阶段列集合一致（config 期望 21 列，不含 `timestamp_original`/`error_flag`，实际输出会保留/新增）；填充逻辑仅动核心列，错误列原样保留。

#### 10.1.2 Swap
- 路径示例：`...\2.cleaned_step2_firstdataclean\binance\swap\ETH_USDT\ETH_USDT_1hour_binance_swap_firstclean.csv`
- 列与类型：与 Spot 相同（`count/taker_buy_volume/taker_buy_quote_volume` 仍保留）；若输入仍采用 `trades/taker_buy_base/taker_buy_quote` 也会被保留但不会被强制转换，需确保与上游打标一致。  
- ⚠️ 由于 `exchange_formats` 将 Swap 与 Spot 等价处理，列名若与官方 Swap 定义不一致可能降低格式检测置信度，建议与 `_premark` 保持一致。

### 10.2 OKX
#### 10.2.1 Spot
- 路径示例：`...\2.cleaned_step2_firstdataclean\okx\spot\BTC_USDT\BTC_USDT_4hour_okx_spot_firstclean.csv`
- 列与类型  
| 列名 | 类型 | 说明 |
|------|------|------|
| timestamp | int64 | 毫秒时间戳 |
| datetime | Utf8 | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| volume_currency | float64 | 币本位成交额 |
| volume_quote | float64 | 计价币成交额 |
| confirm | int64 | 成交确认标记 |
| timestamp_original | int64 | 若上游输出则保留 |
| timestamperro | Utf8 | 时间戳错误标记 |
| openerro | Utf8 | 开盘价错误标记 |
| higherro | Utf8 | 最高价错误标记 |
| lowerro | Utf8 | 最低价错误标记 |
| closeerro | Utf8 | 收盘价错误标记 |
| volumeerro / volumerro | Utf8 | 成交量错误标记 |
| OHLC Logic | Utf8 | OHLC 逻辑错误标记 |
| Time Series | Utf8 | 时间序列错误标记 |
| Price Precision | Utf8 | 价格精度错误标记 |
| error_flag | Utf8 | 本阶段汇总错误 |
- ⚠️ config 预期列数 19（核心+3 个 volume 列+9 个错误列），`error_flag` 与 `timestamp_original` 视输入/处理动态增加。

#### 10.2.2 Swap
- 路径示例：`...\2.cleaned_step2_firstdataclean\okx\swap\BTC_USDT\BTC_USDT_1day_okx_swap_firstclean.csv`
- 列与类型：核心 OHLCV + 错误列与 Spot 相同；`exchange_formats` 为 Swap 不再强制 `volume_currency/volume_quote/confirm`，如上游仍保留这些列会被原样写出但列数会超出 config 预期（14），需确保上下游一致。  
- ⚠️ 若存在 `volume_currency` 等列，请在打标阶段保持列名一致以避免格式检测置信度下降。

### 10.3 Bybit
#### 10.3.1 Spot
- 路径示例：`...\2.cleaned_step2_firstdataclean\bybit\spot\ETH_USDT\ETH_USDT_15min_bybit_spot_firstclean.csv`
- 列与类型  
| 列名 | 类型 | 说明 |
|------|------|------|
| timestamp | int64 | 毫秒时间戳 |
| datetime | Utf8 | 可读时间 |
| open | float64 | 开盘价 |
| high | float64 | 最高价 |
| low | float64 | 最低价 |
| close | float64 | 收盘价 |
| volume | float64 | 成交量 |
| timestamp_original | int64 | 若存在则保留 |
| timestamperro | Utf8 | 时间戳错误标记 |
| openerro | Utf8 | 开盘价错误标记 |
| higherro | Utf8 | 最高价错误标记 |
| lowerro | Utf8 | 最低价错误标记 |
| closeerro | Utf8 | 收盘价错误标记 |
| volumeerro / volumerro | Utf8 | 成交量错误标记 |
| OHLC Logic | Utf8 | OHLC 逻辑错误标记 |
| Time Series | Utf8 | 时间序列错误标记 |
| Price Precision | Utf8 | 价格精度错误标记 |
| error_flag | Utf8 | 本阶段汇总错误 |
- ⚠️ config 预期列数 16（核心 7 + 9 个错误列），`timestamp_original/error_flag` 视情况增加。

#### 10.3.2 Swap（linear）
- 路径示例：`...\2.cleaned_step2_firstdataclean\bybit\swap\ETH_USDT\ETH_USDT_1week_bybit_swap_firstclean.csv`
- 列与类型：与 Spot 完全一致；目录名固定 `swap`，未引入 `linear` 子目录，文件名 `_swap_firstclean`。  
- ⚠️ 若上游以 `linear` 作为 market_type，请在落盘前转换为 `swap` 以匹配处理器的路径发现逻辑。

## 11. 错误类型清单与 NaN 填充规则（详尽版）
- 严重错误（批量 NaN 填充，写入 `error_flag`）：`UNCONVERTIBLE_TIMESTAMP`、`INVALID_TIMESTAMP`、`FUTURE_TIMESTAMP`、`MISSING_OHLCV`、`NEGATIVE_PRICE`、`NEGATIVE_VOLUME`、`HL_SWAP`、`H_OUT_BOTH`、`L_OUT_BOTH`。
- 一般错误（保留数据，仅标记）：`INVALID_TIMESTAMP_FORMAT`、`TIMESTAMP_RANGE_ERROR`、`INVALID_OHLCV_DTYPE`、`NULL_VALUE`、`ZERO_VOLUME`、`H_OUT_OCMAX`、`L_OUT_OCMIN`、`TIME_DISORDER`、`DUPLICATE_TIMESTAMP`、`DUPLICATE_TIMESTAMP_SAME`、`MISSING_TIMEPERIOD`、`PRICE_PRECISION_LOSS`。
- 其他可能出现且会被保留的打标码：`MISSING_TIMESTAMP`、`UNCONVERTIBLE_OPEN/HIGH/LOW/CLOSE/VOLUME`（保持原样但若行已标记则空值会被 NaN 化）、`OHLCV_THRESHOLD_EXCEEDED`（由本阶段在阈值填充时追加）。
- 填充与保留规则  
| 错误码 | 影响列 | 处理动作 | 输出标记 |
|--------|--------|----------|---------|
| UNCONVERTIBLE_TIMESTAMP / INVALID_TIMESTAMP / FUTURE_TIMESTAMP | timestamp, datetime | 直接置 NaN（空字符串写出），`error_flag` 追加同名标记 | error_flag |
| MISSING_OHLCV | open/high/low/close/volume | 全部置 NaN | error_flag |
| NEGATIVE_PRICE | open/high/low/close | 置 NaN | error_flag |
| NEGATIVE_VOLUME | volume | 置 NaN | error_flag |
| HL_SWAP / H_OUT_BOTH / L_OUT_BOTH | open/high/low/close | 置 NaN | error_flag |
| OHLCV 错误计数 >2（`unconvertible_threshold`=2） | open/high/low/close/volume | 整行 OHLCV 置 NaN，`error_flag` 增加 `OHLCV_THRESHOLD_EXCEEDED` | error_flag |
| INVALID_TIMESTAMP_FORMAT / TIMESTAMP_RANGE_ERROR | timestamp | 保留数据，不自动填充；若核心列为空且该行有任意错误标记，会被 `_fill_core_columns_with_nan` 置 NaN | 原错误列 |
| INVALID_OHLCV_DTYPE / NULL_VALUE / ZERO_VOLUME | 对应 OHLCV 列 | 保留数据；若该行带标记且值为空、`""` 或 `"nan"`，则置 NaN | 原错误列 |
| H_OUT_OCMAX / L_OUT_OCMIN | open/high/low/close | 保留数据；值为空时同上规则 | 原错误列 |
| TIME_DISORDER / DUPLICATE_TIMESTAMP / DUPLICATE_TIMESTAMP_SAME | 时间序列 | 不删除行，仅标记；重复行全部保留 | 原错误列 |
| MISSING_TIMEPERIOD | 时间序列 | `_handle_missing_timeperiods_safe` 插入缺口行：timestamp/datetime 按间隔生成，核心数值列填 NaN，`Time Series` 与 `error_flag` 置 `MISSING_TIMEPERIOD` | Time Series + error_flag |
| PRICE_PRECISION_LOSS | 价格精度 | 保留数据，仅标记 | 原错误列 |
- 核心填充机制：只要行内任一错误列或 `error_flag` 非空，且核心列值为 `null/""/"nan"`，会在 `_fill_core_columns_with_nan` 中转换为真正的 NaN；未标记的异常值（例如未打标的负价）会被原样保留，便于后续跨源修复。
- 重复时间戳：`_handle_duplicate_timestamps` 仅统计不删除；排序规则保持输入顺序，插入的缺口行按 timestamp 排序。
- 写出格式：`write_csv(null_value="")`，因此 NaN/None 将以空单元格保存。

## 12. 注意事项与差异汇总（NaN 填充阶段）
- 🔍 路径发现依赖 `marked_data/{exchange}/{market_type}/{symbol}/*_premark.csv`，Bybit 永续仍放 `swap`，不要切换为 `linear` 否则被跳过。
- ⚠️ Binance Swap 与 Spot 在 config 中使用相同列定义；若上游仍用 `trades/taker_buy_base/taker_buy_quote`，需保持与打标时一致，避免检测置信度下降。
- ⚠️ OKX Swap 的 `exchange_formats` 不强制 `volume_currency/volume_quote/confirm`，但上游如存在会被完整透传；确保上下游列数预期一致以避免“列数不匹配”警告。
- 🔍 `error_flag` 为本阶段新增汇总列，使用 `|` 拼接，多重填充（严重错误/阈值/缺口插入）均会追加，不会覆盖原错误列。
- 🔍 处理耗时记录写入 `2.cleaned_step2_firstdataclean/Processing_time.csv`，可用作 tracker；该文件使用 symbol 中的原下划线形式，timeframe 从文件名提取。
- ⚠️ 仍需保持 tracker/`.download_state` 的无下划线 symbol + 周期简写，与生产数据分离，防止清洗结果与下载状态文件混放。
