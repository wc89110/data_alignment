# 第一步数据清洗 - 错误类型完整清单

## 📋 概述

本文档详细列出**第一步数据清洗**中检测的所有**明显逻辑错误**类型，为多源数据清洗提供标准化错误分类和处理策略。

**设计原则：**
- ✅ **只检测单源内部的明显逻辑错误**
- ✅ **不涉及跨源修复或复杂决策**
- ✅ **不处理需要业务判断的复杂逻辑**（如价格跳跃、成交量突增等）
- ✅ **能标记就标记，不轻易删除**（除非100%确定无法修复）

**适用场景：**
- ✅ 多源数据（3个交易所：binance/okx/bybit）
- ✅ 有跨源修复计划（第二步/第三步清洗）
- ✅ 需要最大化保留数据完整性

---

## 🎯 核心处理策略：基于错误数量的阈值判断 + NA填充

### 策略1：阈值判断（错误数量阈值 = 2）

| 参数 | 配置值 | 说明 |
|------|--------|------|
| 错误数量阈值 | 2 | OHLCV字段中无法转换的错误数量界限 |
| 时间戳处理 | 必删 | timestamp无法转换必须删除（跨源匹配基础） |
| 数据源数量 | 3个 | binance/okx/bybit三个交易所 |

**阈值策略执行逻辑：**

| 错误场景 | 错误数量 | 处理方式 | 后续修复可能性 |
|---------|---------|---------|---------------|
| timestamp无法转换 | 1个 | NA填充 | 无法跨源匹配 |
| OHLCV字段错误 | ≤2个 | 标记E | 高（可从其他交易所补充） |
| OHLCV字段错误 | >2个 | NA填充 | 低（修复难度大） |

### 策略2：NA填充代替删除

**设计理念对比表：**

| 方案类型 | 处理方式 | 跨源对比 | 行号对齐 | 推荐度 |
|---------|---------|---------|---------|--------|
| 传统删除方案 | 直接删除错误行 | 困难 | 错位 | ❌ 不推荐 |
| NA填充方案 | 填充NA保留行位置 | 容易 | 完全对齐 | ✅ 强烈推荐 |

**NA填充适用场景表：**

| 场景类型 | 处理方式 | 优势 |
|---------|---------|------|
| 严重错误需要删除 | 填充NA行 | 保留行位置，便于跨源复制 |
| 时间序列缺失 | 插入NA行 | 保持连续性，便于对齐 |
| 重复时间戳完全相同 | 保留一个，其余NA填充 | 自动去重，减少人工工作量 |

---

## 🔄 检测阶段和优先级顺序

### 完整检测流程（按执行顺序）

**检测阶段优先级表：**

| 优先级 | 检测阶段 | 检测内容 | 关键性说明 |
|--------|---------|---------|-----------|
| **P0** | 文件级完整性检测 | CSV文件必需列检查 | 缺少timestamp列直接跳过整个文件 |
| **P1** | timestamp类型检测 | 时间戳可转换性检查 | 跨源匹配的基础，优先级最高 |
| **P2** | OHLCV类型检测 | 数值字段类型检查 | 应用阈值策略（错误数≤2保留） |
| **P3** | OHLC逻辑关系检测 | 价格字段逻辑检查 | high≥max(open,close), low≤min(open,close) |
| **P4** | 数值有效性检测 | 空值/负值/零值检查 | 价格>0, 成交量≥0等基本规则 |
| **P5** | 时间序列检测 | 时间顺序/重复/缺失检查 | 包括乱序、重复、缺失时间段 |

### 阶段依赖关系

文件级完整性 → timestamp有效性 → OHLCV类型 → OHLC逻辑 → 数值有效性 → 时间序列
↓ ↓ ↓ ↓ ↓ ↓
跳过文件 NA填充 阈值判断 标记E 标记E NA填充/标记E


---

##  按字段维度的错误类型说明

### 1️ .timestamp字段错误

#### 错误类型汇总表

| 错误代码 | 错误名称 | 严重程度 | 处理方式 | 典型场景 |
|---------|---------|---------|---------|---------|
| `MISSING_TIMESTAMP` | 时间戳整列缺失 | 🚨 文件级致命 | 跳过整个文件 | CSV缺少timestamp列 |
| `UNCONVERTIBLE_TIMESTAMP` | 时间戳无法转换 | 🚨 行级致命 | NA填充 | timestamp="abc"乱码 |
| `INVALID_TIMESTAMP_FORMAT` | 时间戳格式错误 | ⚠️ 一般错误 | 标记E | timestamp="2021-03-15"字符串 |
| `TIMESTAMP_RANGE_ERROR` | 时间戳范围错误 | ⚠️ 一般错误 | 标记E | timestamp=1634567890（秒级） |
| `INVALID_TIMESTAMP` | 无效时间戳 | 🚨 行级致命 | NA填充 | timestamp=NaT |
| `FUTURE_TIMESTAMP` | 未来时间戳 | 🚨 行级致命 | NA填充 | timestamp超过当前时间 |

#### 时间戳错误处理策略表

| 错误类型 | 可修复性 | 跨源匹配 | 处理原则 |
|---------|---------|---------|---------|
| 完全无法转换 | 不可修复 | 无法匹配 | 必须NA填充 |
| 格式错误但可转换 | 可修复 | 可匹配 | 标记E保留 |
| 范围错误（单位混淆） | 可修复 | 可匹配 | 标记E保留 |

### 2️. open字段错误

#### 错误类型汇总表

| 错误代码 | 错误名称 | 错误级别 | 处理方式 | 阈值策略 |
|---------|---------|---------|---------|---------|
| `MISSING_OHLCV` | open列缺失 | 🚨 文件级 | 标记所有行为D | 不适用 |
| `INVALID_OHLCV_DTYPE` | 类型错误但可转换 | ⚠️ 行级 | 标记E | 不适用 |
| `UNCONVERTIBLE_OPEN` | 无法转换 | ⚠️ 行级 | E或D | 错误数≤2→E, >2→D |
| `NULL_VALUE` | 空值 | ⚠️ 行级 | 标记E | 不适用 |
| `NEGATIVE_PRICE` | 负价格 | ⚠️ 行级 | 标记E | 不适用 |

#### OHLCV阈值策略执行表

| 错误场景 | 错误字段 | 错误数量 | 处理方式 | 修复可能性 |
|---------|---------|---------|---------|-----------|
| 单字段错误 | open | 1个 | 标记E | 高（其他交易所可补充） |
| 双字段错误 | open + close | 2个 | 标记E | 中（部分字段可修复） |
| 多字段错误 | open + high + close | 3个 | NA填充 | 低（修复难度大） |

### 3️. high字段错误

**处理原则与open字段完全相同**，适用相同的阈值策略。

#### 错误类型对应表

| 错误场景 | 典型值 | 错误代码 | 处理方式 |
|---------|--------|---------|---------|
| 整列缺失 | CSV无high列 | `MISSING_OHLCV` | 标记所有行为D |
| 类型错误 | high="101.2" | `INVALID_OHLCV_DTYPE` | 标记E |
| 无法转换 | high="N/A" | `UNCONVERTIBLE_HIGH` | 基于阈值判断 |
| 空值 | high=NaN | `NULL_VALUE` | 标记E |
| 负价格 | high=-101.2 | `NEGATIVE_PRICE` | 标记E |

### 4️. low字段错误

**处理原则与open/high字段完全相同**。

### 5️. close字段错误

**处理原则与open/high/low字段完全相同**。

### 6️. volume字段错误

#### 错误类型特殊说明表

| 错误代码 | 错误名称 | 检测逻辑 | 业务说明 |
|---------|---------|---------|---------|
| `ZERO_VOLUME` | 零成交量 | volume = 0 | 部分交易所允许，需人工判断 |
| `NEGATIVE_VOLUME` | 负成交量 | volume < 0 | 绝对错误，必须标记 |

#### volume字段错误汇总表

| 错误代码 | 处理方式 | 特殊配置 | 业务影响 |
|---------|---------|---------|---------|
| `ZERO_VOLUME` | 标记E | `CHECK_ZERO_VOLUME=True` | 可能为正常现象 |
| `NEGATIVE_VOLUME` | 标记E | 始终检测 | 绝对错误需修复 |

---

## 🔗 复杂逻辑错误类型

### 7️⃣ OHLC逻辑关系错误

#### 逻辑关系定义表

| 字段 | 定义 | 逻辑关系 | 数学表达 |
|------|------|---------|---------|
| high | 时间段内最高价 | 必须≥开收盘价 | high ≥ max(open, close) |
| low | 时间段内最低价 | 必须≤开收盘价 | low ≤ min(open, close) |
| open/close | 开盘/收盘价 | 必须在高低价范围内 | low ≤ open ≤ high, low ≤ close ≤ high |

#### OHLC逻辑错误类型表

| 错误代码 | 错误名称 | 检测逻辑 | 严重程度 | 示例场景 |
|---------|---------|---------|---------|---------|
| `HL_SWAP` | 最高价低于最低价 | high < low | 🚨 严重 | high=99.5, low=101.0 |
| `H_OUT_BOTH` | 最高价未包含开收盘价 | high < min(open,close) | 🚨 严重 | high=99.0, open=100.5, close=100.1 |
| `L_OUT_BOTH` | 最低价未包含开收盘价 | low > max(open,close) | 🚨 严重 | low=101.0, open=100.5, close=100.1 |
| `H_OUT_OCMAX` | 最高价低于OC最大值 | high < max(open,close) | ⚠️ 一般 | high=100.3, open=100.5, close=100.1 |
| `L_OUT_OCMIN` | 最低价高于OC最小值 | low > min(open,close) | ⚠️ 一般 | low=100.2, open=100.5, close=100.1 |

#### 错误优先级排序表

| 优先级 | 错误代码 | 错误严重性 | 修复难度 |
|--------|---------|-----------|---------|
| 1 | `HL_SWAP` | 最严重（违反基本定义） | 高 |
| 2 | `H_OUT_BOTH` / `L_OUT_BOTH` | 严重（完全超出范围） | 中 |
| 3 | `H_OUT_OCMAX` / `L_OUT_OCMIN` | 一般（部分超出范围） | 低 |

### 8️⃣ 时间序列错误

#### 时间序列错误类型表

| 错误代码 | 错误名称 | 检测逻辑 | 处理方式 | 跨源影响 |
|---------|---------|---------|---------|---------|
| `TIME_DISORDER` | 时间乱序 | 后一时间戳 < 前一时间戳 | 标记E | 不影响对齐 |
| `DUPLICATE_TIMESTAMP` | 重复时间戳(OHLCV不同) | 相同时间戳，数据不同 | 标记E | 需要人工判断 |
| `DUPLICATE_TIMESTAMP_SAME` | 重复时间戳(OHLCV相同) | 相同时间戳，数据相同 | 保留一个，其余NA填充 | 自动对齐 |
| `MISSING_TIMEPERIOD` | 时间序列缺失 | 连续时间段缺失 | 插入NA行 | 保持连续性 |

#### 重复时间戳处理策略表

| 重复类型 | 数据一致性 | 处理方式 | 人工介入 | 输出结果 |
|---------|-----------|---------|---------|---------|
| OHLCV完全相同 | 完全一致 | 保留第一个，其余NA填充 | 不需要 | 自动去重 |
| OHLCV不同 | 数据不一致 | 全部标记E | 需要 | 人工复核 |

#### 时间序列缺失处理优势表

| 处理方案 | 时间连续性 | 跨源对齐 | 修复便利性 | 推荐度 |
|---------|-----------|---------|-----------|--------|
| 不处理缺失 | 不连续 | 无法对齐 | 困难 | ❌ |
| 插入NA行 | 连续 | 完全对齐 | 容易 | ✅ |

### 9️⃣ 价格精度异常

#### 精度检测配置表

| 参数 | 配置值 | 说明 |
|------|--------|------|
| `PRICE_PRECISION_MAX` | 8 | 最大允许小数位数 |
| 检测方法 | `(price * 10^8) % 1 != 0` | 检查是否有超过8位有效小数 |

#### 精度异常场景表

| 异常类型 | 典型值 | 可能原因 | 处理方式 |
|---------|--------|---------|---------|
| 轻微精度异常 | 100.12345678 | 正常计算误差 | 可忽略 |
| 严重精度异常 | 100.123456789 | 类型转换错误 | 标记E |
| 极端精度异常 | 100.1234567890123 | 数据源错误 | 标记E |

---

## 📊 错误类型完整汇总

### 按字段分类统计表

| 字段 | 错误数量 | 错误代码列表 |
|------|---------|-------------|
| **timestamp** | 6种 | `MISSING_TIMESTAMP`, `UNCONVERTIBLE_TIMESTAMP`, `INVALID_TIMESTAMP_FORMAT`, `TIMESTAMP_RANGE_ERROR`, `INVALID_TIMESTAMP`, `FUTURE_TIMESTAMP` |
| **open** | 5种 | `MISSING_OHLCV`, `INVALID_OHLCV_DTYPE`, `UNCONVERTIBLE_OPEN`, `NULL_VALUE`, `NEGATIVE_PRICE` |
| **high** | 5种 | `MISSING_OHLCV`, `INVALID_OHLCV_DTYPE`, `UNCONVERTIBLE_HIGH`, `NULL_VALUE`, `NEGATIVE_PRICE` |
| **low** | 5种 | `MISSING_OHLCV`, `INVALID_OHLCV_DTYPE`, `UNCONVERTIBLE_LOW`, `NULL_VALUE`, `NEGATIVE_PRICE` |
| **close** | 5种 | `MISSING_OHLCV`, `INVALID_OHLCV_DTYPE`, `UNCONVERTIBLE_CLOSE`, `NULL_VALUE`, `NEGATIVE_PRICE` |
| **volume** | 6种 | `MISSING_OHLCV`, `INVALID_OHLCV_DTYPE`, `UNCONVERTIBLE_VOLUME`, `NULL_VALUE`, `ZERO_VOLUME`, `NEGATIVE_VOLUME` |
| **OHLC逻辑** | 5种 | `HL_SWAP`, `H_OUT_BOTH`, `L_OUT_BOTH`, `H_OUT_OCMAX`, `L_OUT_OCMIN` |
| **时间序列** | 4种 | `TIME_DISORDER`, `DUPLICATE_TIMESTAMP`, `DUPLICATE_TIMESTAMP_SAME`, `MISSING_TIMEPERIOD` |
| **价格精度** | 1种 | `PRICE_PRECISION_LOSS` |

**总计：22种错误类型**

### 按处理方式分类表

| 处理方式 | 数量 | 代表错误代码 | 处理原则 |
|---------|------|-------------|---------|
| **🚨 NA填充(D)** | 9种 | `UNCONVERTIBLE_TIMESTAMP`, `MISSING_OHLCV` | 严重错误，但保留行位置 |
| **⚠️ 标记(E)** | 13种 | `INVALID_TIMESTAMP_FORMAT`, `UNCONVERTIBLE_OPEN`(阈值内) | 一般错误，保留修复可能 |

### 错误严重程度分布表

| 严重程度 | 错误数量 | 处理优先级 | 业务影响 |
|---------|---------|-----------|---------|
| 🚨 文件级致命 | 2种 | P0（最高） | 整个文件不可用 |
| 🚨 行级致命 | 4种 | P1（高） | 单行无法使用 |
| ⚠️ 严重错误 | 8种 | P2-P3（中） | 需要重点修复 |
| ⚠️ 一般错误 | 8种 | P4-P5（低） | 可后续修复 |

---

## 🔧 配置参数说明

### 核心配置参数表

| 配置类别 | 参数名称 | 默认值 | 说明 |
|---------|---------|--------|------|
| **时间戳配置** | `FUTURE_TIMESTAMP_TOLERANCE_MINUTES` | 5 | 未来时间戳容忍阈值 |
| | `TIMESTAMP_MIN` / `TIMESTAMP_MAX` | 0 / 4102444800000 | 时间戳有效范围(1970-2100) |
| **数据类型配置** | `OHLCV_NUMERIC_DTYPES` | ['float64','int64'等] | 允许的数值类型 |
| | `PRICE_PRECISION_MAX` | 8 | 价格最大小数位数 |
| **删除策略配置** | `UNCONVERTIBLE_THRESHOLD` | 2 | OHLCV错误数量阈值 |
| | `TIMESTAMP_ERROR_MUST_DELETE` | True | 时间戳错误必删 |
| **连续性检查** | `ENABLE_CONTINUITY_CHECK` | True | 启用时间序列连续性检查 |
| | `KLINE_INTERVAL` | '1min' | K线周期 |
| | `MAX_MISSING_TOLERANCE` | 100 | 最大允许缺失数量 |
| **NA填充策略** | `FILL_NA_INSTEAD_DELETE` | True | NA填充代替删除 |
| | `NA_FILL_VALUE` | 'NA' | 填充值 |

### 多源数据场景优化配置表

| 场景类型 | `UNCONVERTIBLE_THRESHOLD` | `FILL_NA_INSTEAD_DELETE` | 优势 |
|---------|--------------------------|-------------------------|------|
| 单源数据 | 0（严格） | False | 数据清洁度高 |
| 多源数据 | 2（宽松） | True | 保留修复可能，便于跨源对比 |

---

## 📝 最终状态标记说明

### 状态代码定义表

| 状态代码 | 状态名称 | 数据处理 | 后续步骤 | 跨源影响 |
|---------|---------|---------|---------|---------|
| `V` | Valid（正常） | 原样保留 | 直接使用 | 无影响 |
| `E` | Error（错误） | 保留原值 | 第二步清洗修复 | 可跨源修复 |
| `D` | Delete（NA填充） | 填充NA行 | 跨源复制或人工复核 | 行位置保留 |

### 状态分布预期表

| 数据质量 | V状态比例 | E状态比例 | D状态比例 | 处理建议 |
|---------|----------|----------|----------|---------|
| 高质量数据 | >99.9% | <0.1% | <0.01% | 可直接使用 |
| 一般质量数据 | 99.0%-99.9% | 0.1%-1.0% | 0.01%-0.1% | 需要清洗 |
| 低质量数据 | <99.0% | >1.0% | >0.1% | 需要重点处理 |

---

## 🚫 不包含的错误类型说明

### 留待后续处理的复杂错误表

| 错误类别 | 具体错误类型 | 排除原因 | 处理阶段 |
|---------|-------------|---------|---------|
| 价格异常 | `PRICE_JUMP`, `PRICE_SPIKE` | 需要业务阈值判断 | 第二步清洗 |
| 成交量异常 | `VOLUME_SPIKE`, `VOLUME_ANOMALY` | 需要统计分析 | 第二步清洗 |
| 跳空缺口 | `GAP_TOO_LARGE` | 可能是正常市场行为 | 业务判断 |
| 数据缺失 | `MISSING_PERIOD`, `DATA_GAP` | 需要跨周期分析 | 完整性检查 |
| 价格关系异常 | `PRICE_DEVIATION`, `SPREAD_ABNORMAL` | 需要跨源对比 | 第三步清洗 |

---

## 📖 相关文档体系

### 文档关联关系表

| 文档名称 | 主要内容 | 阅读顺序 |
|---------|---------|---------|
| `README.md` | 系统总体说明 | 1 |
| `错误类型完整清单.md` | 错误分类和处理策略（本文档） | 2 |
| `阈值删除策略说明.md` | 详细的阈值策略说明 | 3 |
| `清洗结果报告.md` | 报告格式和指标说明 | 4 |
| `使用指南.md` | 实际操作指南 | 5 |
| `架构说明.md` | 系统架构设计 | 6 |

---

## 📅 版本历史演进

### 版本功能对比表

| 版本 | 核心特性 | 错误类型数量 | 处理策略 |
|------|---------|-------------|---------|
| v1.6 | NA填充策略 + 时间序列连续性检查 | 22种 | NA填充代替删除 |
| v1.5 | 按字段维度组织文档 | 20种 | 细化字段错误 |
| v1.4 | 阈值删除策略（多源优化） | 18种 | 错误数阈值判断 |
| v1.3 | 数据类型检测逻辑修正 | 16种 | 区分可转换错误 |
| v1.0-1.2 | 基础错误检测 | 15种 | 简单删除策略 |

### v1.6版本重大改进表

| 改进方面 | v1.5方案 | v1.6方案 | 改进效果 |
|---------|---------|---------|---------|
| 严重错误处理 | 直接删除 | NA填充 | 保留行位置，便于跨源对比 |
| 时间序列缺失 | 不处理 | 插入NA行 | 保持连续性，便于对齐 |
| 重复时间戳 | 标记E人工判断 | 智能去重 | 减少人工工作量 |
| 跨源修复 | 困难 | 容易 | 行号完全对齐 |

### 版本适用场景表

| 版本 | 数据源数量 | 跨源修复 | 推荐度 |
|------|-----------|---------|--------|
| v1.6 | 多源(≥2个) | 需要 | ✅ 强烈推荐 |
| v1.4 | 多源(≥2个) | 需要 | ⚠️ 可用 |
| v1.2 | 单源 | 不需要 | ❌ 不推荐 |

---

**文档信息**  
**生成时间**: 2025-10-22  
**文档版本**: v1.6.0 ⭐ **NA填充策略版**  
**文档状态**: ✅ 最新版本  
**总错误类型**: 22种  
**核心特性**: NA填充代替删除 + 时间序列连续性检查 + 阈值策略优化

**适用场景**: 
- ✅ 多源数据对比分析
- ✅ 跨源数据修复流程
- ✅ 高完整性数据要求
- ✅ 自动化清洗流程


